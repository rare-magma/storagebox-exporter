name: Create and publish artifacts

on:
  push:
    branches:
      - main
  schedule:
    - cron: "2 02 4 * *"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # ratchet:actions/checkout@v6
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # ratchet:actions/setup-go@v6
        with:
          go-version: "stable"

      - name: Lint
        run: |
          set -euo pipefail

          gofmt -s -w .
          git diff --exit-code

          go vet ./...

          go mod tidy
          git diff --exit-code

          go mod download
          go mod verify

          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  build-and-push-image:
    name: Build and push container image
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # ratchet:actions/checkout@v6

      - name: Authenticate to GHCR
        run: |
          set -euo pipefail
          echo "${GITHUB_TOKEN}" | docker login ghcr.io \
            -u "${GITHUB_ACTOR}" \
            --password-stdin

      - name: Set up Docker Buildx
        run: |
          set -euo pipefail
          docker buildx create --use --name ci-builder || docker buildx use ci-builder
          docker buildx inspect --bootstrap

      - name: Build and push image
        id: build
        run: |
          set -euo pipefail

          IMAGE="${REGISTRY}/${IMAGE_NAME}:latest"
          CREATED="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --tag "${IMAGE}" \
            --label org.opencontainers.image.source="https://github.com/${GITHUB_REPOSITORY}" \
            --label org.opencontainers.image.revision="${GITHUB_SHA}" \
            --label org.opencontainers.image.created="${CREATED}" \
            --push \
            .

          DIGEST="$(docker buildx imagetools inspect "${IMAGE}" | awk '/Digest:/ {print $2; exit}')"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Generate image attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  releases:
    name: Build and release Go binaries
    needs: lint
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # ratchet:actions/checkout@v6
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # ratchet:actions/setup-go@v6
        with:
          go-version: "stable"

      - name: Build binaries for all architectures
        env:
          CGO_ENABLED: 0
          NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail

          for arch in amd64 arm64; do
            GOOS=linux GOARCH=$arch go build -trimpath -ldflags="-s -w" -o "$NAME" main.go

            zip -q "$NAME-linux-$arch.zip" "$NAME"
            rm "$NAME"
          done

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # ratchet:actions/attest-build-provenance@v3
        with:
          subject-path: "*.zip"

      - name: Create GitHub release
        run: |
          set -euo pipefail

          gh release delete latest -y || true
          gh release create latest *.zip --title "latest"
